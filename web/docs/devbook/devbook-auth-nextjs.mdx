---
id: devbook-auth-nextjs
title: "Next.js Auth Tutorial"
description: Learn how to use Supabase Auth in your Next App.
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Editor, { Language } from '../../src/components/DevbookVMFileEditor';
import OldEditor from '../../src/components/DevbookEditor';
import File from '../../src/components/DevbookVMFile';
import Iframe from '../../src/components/DevbookIframe';
import Shell from '../../src/components/DevbookShell';
import * as snippets from '../../src/data/devbookTutorialCodeSnippets';
import Center from '../../src/components/DevbookCenter';
import { Env } from '@devbookhq/sdk';

<Center env={Env.NextJS} />

<File
  filepath="/utils/initSupabase.tsx"
  code={snippets.utilsInitSupabase}
/>
<File 
  filepath="/pages/api/getUser.tsx"
  code={snippets.pagesAPIGetUser}
/>
<File 
  filepath="/pages/api/auth.tsx"
  code={snippets.pagesAPIAuth}
/>
<File 
  filepath="/pages/profile.tsx"
  code={snippets.pagesProfile}
/>
<File 
  filepath="/pages/index.tsx"
  code={snippets.pagesIndex}
/>
<File 
  filepath="/pages/_app.tsx"
  code={snippets.pagesApp}
/>

## Intro

This tutorial will teach you how to use Supabase for authentication in a NextJS app.

## Project set up

Before we start building we're going to set up our Database and API. This is as simple as starting a new Project in Supabase 
and then creating a "schema" inside the database.

### Create a project

<!-- How to integrate with Supabase so we don't have to instruct user on how to create new project on a separate site? -->

1. Go to [app.supabase.io](https://app.supabase.io).
1. Click on "New Project".
1. Enter your project details.
1. Wait for the new database to launch.

### Set up the database schema

<!-- How to integrate with Supabase so we don't have to instruct user how to control SQL via web console? -->

Now we are going to set up the database schema. We can use the "User Management Starter" quickstart in the SQL Editor, 
or you can just copy/paste the SQL from below and run it yourself.

<!-- Init SQL db with psql command? -->
<!-- Connect to the supabase project -> fill env vars in the snippets (can we automate this?) -->
<!-- Better integration -->

1. Go to the "SQL" section for your project on [app.supabase.io](https://app.supabase.io/).
2. Click "User Management Starter".
3. Click "Run".


### Get the API Keys

Now that you've created some database tables, you are ready to insert data using the auto-generated API. 
We just need to get the URL and `anon` key from the API settings.

1. Go to the "Settings" section for your project on [app.supabase.io](https://app.supabase.io/).
2. Click "API" in the sidebar.
3. Find your API URL in this page.
4. Find your "anon" and "service_role" keys on this page.

Then paste the Supabase URL and the "anon" key as `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` to the code bellow.
This will initialize the Supabase client that we will user later.

<Editor
  language={Language.tsx}
  filepath="/utils/initSupabase.tsx"
  code={snippets.utilsInitSupabase}
/>

### Install project dependencies

<!-- Make this automatic? -->
<!-- Waiting too long for results - add loading indicator for exit command -->
Run the following commands to install NPM dependencies:

<Shell
  autorun={true}
  command={"npm install @supabase/supabase-js\nnpm install @supabase/ui\nnpm install swr"}
/>

## Project

<!-- Use `Editor` to show code and describe important parts of the implementation -->

The example project is a NextJS app that has two API endpoints (`/api/auth`, `/api/getUser`) used for managing authentication 
and two pages (`/`, `/profile`) showing the authentication in action.


Before we start defining pages, we need to enable Supabase on the NextJS pages.

To do that we add the Supabase client initialized in the project setup to the `_app.tsx` file (https://nextjs.org/docs/advanced-features/custom-app) via a provider.

<Editor
  language={Language.tsx}
  filepath="/pages/_app.tsx"
  code={snippets.pagesApp}
/>


### Pages
On the `/` page we handle the authentication logic by using the `Auth.useUser` hook to access `user` and `session` objects from the Supabase provider.
We then use these values to fetch user information from the `/api/getUser` API endpoint by using the `useSWR` hook.

In the `useEffect` we subscribe to the `supabase.auth.onAuthStateChange` event so we can update the Supabase auth cookie
by caling the `/api/auth` API endpoint. This allows us to acquire the current user in `getServerSideProps` when rendering with SSR.

We use premade `Auth` component from the `@supabase/ui` package for handling the authentication flow.

<Editor
  language={Language.tsx}
  filepath="/pages/index.tsx"
  code={snippets.pagesIndex}
/>

<br/>

<!-- We could really use reference to code symbols or code lines in file to make this section better. -->
The `/profile` page displays the currently signed in user.
We use the `getServerSideProps` to decode `user` object
from the HTTP request and then we pass the `user` object as a prop to the page.
When we fail to decode `user` from the request we redirect user to page `/`.
<Editor
  language={Language.tsx}
  filepath="/pages/profile.tsx"
  code={snippets.pagesProfile}
/>


### API Endpoints

The first NextJS API endpoint we define is `/api/getUser`. It decodes the token sent in the header (`req.headers.token`) 
and returns a `user` object that contains the Supabase Authentication info about the user.

<Editor
  language={Language.tsx}
  filepath="/pages/api/getUser.tsx"
  code={snippets.pagesAPIGetUser}
/>

<br/>

The other endpoint - `/api/auth` - is used for setting the Supabase auth cookie 
so the SSR methods for pages (like the [`getServerSideProps`](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props)) can access it.

<Editor
  language={Language.tsx}
  filepath="/pages/api/auth.tsx"
  code={snippets.pagesAPIAuth}
/>


<!-- TODO: Fix iframe — connection error before the env’s running process is ready -->
<!-- Add nextjs server output so we can see error when we edit code in the snippets - maybe we want to add this output globally, to every editor, or to iframe? -->
